{% extends "base.html" %}

{% block title %}Create Task - GemPundit CRM{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Page Header -->
    <div class="mb-6">
        <a href="{{ url_for('main.dashboard') }}" class="text-blue-600 hover:text-blue-700 text-sm font-medium mb-2 inline-flex items-center">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Back to Dashboard
        </a>
        <h1 class="text-3xl font-bold text-gray-900 mt-2">Create New Task</h1>
        <p class="text-gray-600 mt-1">Create a content task with specific requirements</p>
    </div>

    <!-- Validation Summary (hidden by default) -->
    <div id="validationSummary" class="card bg-red-50 border-red-200 mb-6" style="display: none;">
        <div class="card-body p-4">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3 flex-1">
                    <h3 class="text-sm font-medium text-red-800">Please correct the following errors:</h3>
                    <div class="mt-2 text-sm text-red-700">
                        <ul id="validationErrorList" class="list-disc list-inside space-y-1"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Server-side Validation Errors -->
    {% if form.errors %}
    <div class="card bg-red-50 border-red-200 mb-6">
        <div class="card-body p-4">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3 flex-1">
                    <h3 class="text-sm font-medium text-red-800">Please correct the following errors:</h3>
                    <div class="mt-2 text-sm text-red-700">
                        <ul class="list-disc list-inside space-y-1">
                            {% for field, errors in form.errors.items() %}
                                {% for error in errors %}
                                    <li>{{ form[field].label.text }}: {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Form Card -->
    <div class="card">
        <div class="card-body p-8">
            <form method="POST" action="{{ url_for('main.create_task') }}" novalidate id="createTaskForm">
                {{ form.hidden_tag() }}

                <!-- Basic Task Information -->
                <div class="mb-8 pb-6 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Task Details</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Task Title -->
                        <div class="md:col-span-2">
                            <label for="title" class="form-label">
                                Task Title <span class="text-red-600">*</span>
                            </label>
                            {{ form.title(class="form-input" + (" border-red-500" if form.title.errors else ""),
                                         placeholder="Enter a clear, descriptive title",
                                         required=true) }}
                            {% if form.title.errors %}
                                {% for error in form.title.errors %}
                                <p class="form-error">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <!-- Comments/Notes -->
                        <div class="md:col-span-2">
                            <label for="description" class="form-label">
                                Comments/Notes <span class="text-gray-400 text-sm">(Optional)</span>
                            </label>
                            {{ form.description(class="form-input" + (" border-red-500" if form.description.errors else ""),
                                               rows="3",
                                               placeholder="Add any additional comments or notes (Optional)") }}
                            {% if form.description.errors %}
                                {% for error in form.description.errors %}
                                <p class="form-error">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                            <p class="text-sm text-gray-500 mt-1">Optional field for additional information</p>
                        </div>

                        <!-- Assign To -->
                        <div>
                            <label for="assigned_to" class="form-label">
                                Assign To <span class="text-red-600">*</span>
                            </label>
                            {{ form.assigned_to(class="form-input" + (" border-red-500" if form.assigned_to.errors else ""),
                                               required=true) }}
                            {% if form.assigned_to.errors %}
                                {% for error in form.assigned_to.errors %}
                                <p class="form-error">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <!-- Plan Date -->
                        <div>
                            <label for="plan_date" class="form-label">
                                Planned Completion Date <span class="text-red-600">*</span>
                            </label>
                            {{ form.plan_date(class="form-input" + (" border-red-500" if form.plan_date.errors else ""),
                                             required=true) }}
                            {% if form.plan_date.errors %}
                                {% for error in form.plan_date.errors %}
                                <p class="form-error">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>


                <!-- SECTION 1: Basic Information -->
                <div class="mb-8 pb-6 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Section 1: Basic Information</h2>

                    <div class="grid grid-cols-1 gap-6">
                        <!-- Content Type -->
                        <div>
                            <label for="category_type" class="form-label">
                                Content Type <span class="text-red-600">*</span>
                            </label>
                            {{ form.category_type(class="form-input" + (" border-red-500" if form.category_type.errors else ""),
                                                 id="category_type",
                                                 required=true) }}
                            {% if form.category_type.errors %}
                                {% for error in form.category_type.errors %}
                                <p class="form-error">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <!-- Table 1: Content Metrics -->
                        <div>
                            <div class="flex justify-between items-center mb-3">
                                <label class="form-label mb-0">
                                    Content Metrics <span class="text-red-600">*</span>
                                </label>
                                <button type="button" id="addMetricRow" class="btn btn-sm bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                                    + Add Row
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full border border-gray-300 rounded-lg">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold text-gray-700">Type <span class="text-red-600">*</span></th>
                                            <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold text-gray-700">Keyword <span class="text-red-600">*</span></th>
                                            <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold text-gray-700">Search Volume <span class="text-red-600">*</span></th>
                                            <th class="border border-gray-300 px-4 py-2 text-center text-sm font-semibold text-gray-700" style="width: 80px;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="metricsTableBody">
                                        <!-- Dynamic rows will be added here -->
                                        <tr class="metric-row">
                                            <td class="border border-gray-300 px-2 py-2">
                                                <select name="type[]" class="form-input w-full metric-type" required>
                                                    <option value="">Select Type</option>
                                                    <option value="Primary">Primary</option>
                                                    <option value="Secondary">Secondary</option>
                                                </select>
                                            </td>
                                            <td class="border border-gray-300 px-2 py-2">
                                                <input type="text" name="keyword[]" class="form-input w-full metric-keyword" placeholder="Enter keyword" required>
                                            </td>
                                            <td class="border border-gray-300 px-2 py-2">
                                                <input type="text" name="search_volume[]" class="form-input w-full metric-sv" placeholder="Enter search volume" required>
                                            </td>
                                            <td class="border border-gray-300 px-2 py-2 text-center">
                                                <button type="button" class="removeMetricRow text-red-600 hover:text-red-800 font-semibold">Remove</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <p class="text-sm text-gray-500 mt-2">Add multiple rows for different keywords and their metrics.</p>
                        </div>

                        <!-- Meta Title -->
                        <div>
                            <label for="title_field" class="form-label">
                                Meta Title <span class="text-red-600">*</span>
                            </label>
                            {{ form.title_field(class="form-input" + (" border-red-500" if form.title_field.errors else ""),
                                               placeholder="Enter meta title",
                                               required=true) }}
                            {% if form.title_field.errors %}
                                {% for error in form.title_field.errors %}
                                <p class="form-error">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <!-- Meta Description -->
                        <div>
                            <label for="meta_description" class="form-label">
                                Meta Description <span class="text-red-600">*</span>
                            </label>
                            {{ form.meta_description(class="form-input" + (" border-red-500" if form.meta_description.errors else ""),
                                                    rows="2",
                                                    placeholder="Enter meta description",
                                                    required=true) }}
                            {% if form.meta_description.errors %}
                                {% for error in form.meta_description.errors %}
                                <p class="form-error">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <!-- Table 2: Linking Data -->
                        <div>
                            <div class="flex justify-between items-center mb-3">
                                <label class="form-label mb-0">
                                    Linking Data <span class="text-red-600">*</span>
                                </label>
                                <button type="button" id="addLinkingRow" class="btn btn-sm bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                                    + Add Row
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full border border-gray-300 rounded-lg">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold text-gray-700">Internal Linking Keywords <span class="text-red-600">*</span></th>
                                            <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold text-gray-700">Internal Link URLs <span class="text-red-600">*</span></th>
                                            <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold text-gray-700">Internal Linking Keywords SV <span class="text-red-600">*</span></th>
                                            <th class="border border-gray-300 px-4 py-2 text-center text-sm font-semibold text-gray-700" style="width: 80px;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="linkingTableBody">
                                        <!-- Dynamic rows will be added here -->
                                        <tr class="linking-row">
                                            <td class="border border-gray-300 px-2 py-2">
                                                <input type="text" name="internal_linking_keywords[]" class="form-input w-full linking-keywords" placeholder="Enter keywords" required>
                                            </td>
                                            <td class="border border-gray-300 px-2 py-2">
                                                <input type="text" name="internal_link_urls[]" class="form-input w-full linking-urls" placeholder="Enter URLs" required>
                                            </td>
                                            <td class="border border-gray-300 px-2 py-2">
                                                <input type="text" name="internal_linking_keywords_sv[]" class="form-input w-full linking-sv" placeholder="Enter SV" required>
                                            </td>
                                            <td class="border border-gray-300 px-2 py-2 text-center">
                                                <button type="button" class="removeLinkingRow text-red-600 hover:text-red-800 font-semibold">Remove</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <p class="text-sm text-gray-500 mt-2">Add multiple rows for different internal linking strategies.</p>
                        </div>

                        <!-- FAQs -->
                        <div>
                            <label for="faqs" class="form-label">
                                FAQs <span class="text-red-600">*</span>
                            </label>
                            {{ form.faqs(class="form-input" + (" border-red-500" if form.faqs.errors else ""),
                                        rows="3",
                                        placeholder="Enter FAQs",
                                        required=true) }}
                            {% if form.faqs.errors %}
                                {% for error in form.faqs.errors %}
                                <p class="form-error">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- SECTION 2: Category-Specific Fields -->
                <div id="categorySection" class="mb-8 pb-6 border-b border-gray-200" style="display: none;">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Section 2: Category-Specific Fields <span class="text-sm text-red-600">(All fields required when Category is selected)</span></h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Page Type -->
                        <div>
                            <label for="page_type" class="form-label">
                                Page Type <span class="required-indicator text-red-600" style="display: none;">*</span>
                            </label>
                            {{ form.page_type(class="form-input category-field" + (" border-red-500" if form.page_type.errors else ""),
                                             placeholder="Enter page type") }}
                            {% if form.page_type.errors %}
                                {% for error in form.page_type.errors %}
                                <p class="form-error">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <!-- Category Name -->
                        <div>
                            <label for="category_name" class="form-label">
                                Category Name <span class="required-indicator text-red-600" style="display: none;">*</span>
                            </label>
                            {{ form.category_name(class="form-input category-field" + (" border-red-500" if form.category_name.errors else ""),
                                                 placeholder="Enter category name") }}
                            {% if form.category_name.errors %}
                                {% for error in form.category_name.errors %}
                                <p class="form-error">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <!-- URL -->
                        <div>
                            <label for="url" class="form-label">
                                URL <span class="required-indicator text-red-600" style="display: none;">*</span>
                            </label>
                            {{ form.url(class="form-input category-field" + (" border-red-500" if form.url.errors else ""),
                                       placeholder="Enter URL") }}
                            {% if form.url.errors %}
                                {% for error in form.url.errors %}
                                <p class="form-error">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <!-- Page SV -->
                        <div>
                            <label for="page_sv" class="form-label">
                                Page SV <span class="required-indicator text-red-600" style="display: none;">*</span>
                            </label>
                            {{ form.page_sv(class="form-input category-field" + (" border-red-500" if form.page_sv.errors else ""),
                                           placeholder="Enter page SV") }}
                            {% if form.page_sv.errors %}
                                {% for error in form.page_sv.errors %}
                                <p class="form-error">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <!-- Gemstone Category -->
                        <div>
                            <label for="gemstone_category" class="form-label">
                                Gemstone Category <span class="required-indicator text-red-600" style="display: none;">*</span>
                            </label>
                            {{ form.gemstone_category(class="form-input category-field" + (" border-red-500" if form.gemstone_category.errors else "")) }}
                            {% if form.gemstone_category.errors %}
                                {% for error in form.gemstone_category.errors %}
                                <p class="form-error">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <!-- Recommended Density -->
                        <div>
                            <label for="recommended_density" class="form-label">
                                Recommended Density <span class="required-indicator text-red-600" style="display: none;">*</span>
                            </label>
                            {{ form.recommended_density(class="form-input category-field" + (" border-red-500" if form.recommended_density.errors else ""),
                                                       placeholder="Enter recommended density") }}
                            {% if form.recommended_density.errors %}
                                {% for error in form.recommended_density.errors %}
                                <p class="form-error">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <!-- Word Count -->
                        <div>
                            <label for="word_count" class="form-label">
                                Word Count <span class="required-indicator text-red-600" style="display: none;">*</span>
                            </label>
                            {{ form.word_count(class="form-input category-field" + (" border-red-500" if form.word_count.errors else ""),
                                              placeholder="Enter word count") }}
                            {% if form.word_count.errors %}
                                {% for error in form.word_count.errors %}
                                <p class="form-error">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <!-- Astro/Non-Astro -->
                        <div>
                            <label for="astro_non_astro" class="form-label">
                                Astro/Non-Astro <span class="required-indicator text-red-600" style="display: none;">*</span>
                            </label>
                            {{ form.astro_non_astro(class="form-input category-field" + (" border-red-500" if form.astro_non_astro.errors else "")) }}
                            {% if form.astro_non_astro.errors %}
                                {% for error in form.astro_non_astro.errors %}
                                <p class="form-error">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- SECTION 3: Blog-Specific Fields -->
                <div id="blogSection" class="mb-8 pb-6 border-b border-gray-200" style="display: none;">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">Section 3: Blog-Specific Fields <span class="text-sm text-red-600">(All fields required when Blog is selected)</span></h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Blog URL -->
                        <div>
                            <label for="blog_url" class="form-label">
                                Blog URL <span class="required-indicator text-red-600" style="display: none;">*</span>
                            </label>
                            {{ form.blog_url(class="form-input blog-field" + (" border-red-500" if form.blog_url.errors else ""),
                                            placeholder="Enter blog URL") }}
                            {% if form.blog_url.errors %}
                                {% for error in form.blog_url.errors %}
                                <p class="form-error">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <!-- Keyword SV -->
                        <div>
                            <label for="keyword_sv" class="form-label">
                                Keyword SV <span class="required-indicator text-red-600" style="display: none;">*</span>
                            </label>
                            {{ form.keyword_sv(class="form-input blog-field" + (" border-red-500" if form.keyword_sv.errors else ""),
                                              placeholder="Enter keyword SV") }}
                            {% if form.keyword_sv.errors %}
                                {% for error in form.keyword_sv.errors %}
                                <p class="form-error">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <!-- H1 -->
                        <div>
                            <label for="h1" class="form-label">
                                H1 <span class="required-indicator text-red-600" style="display: none;">*</span>
                            </label>
                            {{ form.h1(class="form-input blog-field" + (" border-red-500" if form.h1.errors else ""),
                                      placeholder="Enter H1 heading") }}
                            {% if form.h1.errors %}
                                {% for error in form.h1.errors %}
                                <p class="form-error">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <!-- Meta Title -->
                        <div>
                            <label for="meta_title" class="form-label">
                                Meta Title <span class="required-indicator text-red-600" style="display: none;">*</span>
                            </label>
                            {{ form.meta_title(class="form-input blog-field" + (" border-red-500" if form.meta_title.errors else ""),
                                              placeholder="Enter meta title") }}
                            {% if form.meta_title.errors %}
                                {% for error in form.meta_title.errors %}
                                <p class="form-error">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>

                        <!-- Content Structure - Recommended -->
                        <div class="md:col-span-2">
                            <label for="content_structure_recommended" class="form-label">
                                Content Structure - Recommended <span class="required-indicator text-red-600" style="display: none;">*</span>
                            </label>
                            {{ form.content_structure_recommended(class="form-input blog-field" + (" border-red-500" if form.content_structure_recommended.errors else ""),
                                                                 rows="4",
                                                                 placeholder="Enter recommended content structure") }}
                            {% if form.content_structure_recommended.errors %}
                                {% for error in form.content_structure_recommended.errors %}
                                <p class="form-error">{{ error }}</p>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex items-center justify-end space-x-4 pt-6">
                    <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline">
                        Cancel
                    </a>
                    {{ form.submit(class="btn btn-primary") }}
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('createTaskForm');
    const categoryTypeSelect = document.getElementById('category_type');
    const categorySection = document.getElementById('categorySection');
    const blogSection = document.getElementById('blogSection');
    const validationSummary = document.getElementById('validationSummary');
    const validationErrorList = document.getElementById('validationErrorList');

    // ===================================================================
    // DYNAMIC TABLE 1: Content Metrics Management
    // ===================================================================
    const metricsTableBody = document.getElementById('metricsTableBody');
    const addMetricRowBtn = document.getElementById('addMetricRow');

    // Function to create a new metric row
    function createMetricRow() {
        const row = document.createElement('tr');
        row.className = 'metric-row';
        row.innerHTML = `
            <td class="border border-gray-300 px-2 py-2">
                <select name="type[]" class="form-input w-full metric-type" required>
                    <option value="">Select Type</option>
                    <option value="Primary">Primary</option>
                    <option value="Secondary">Secondary</option>
                </select>
            </td>
            <td class="border border-gray-300 px-2 py-2">
                <input type="text" name="keyword[]" class="form-input w-full metric-keyword" placeholder="Enter keyword" required>
            </td>
            <td class="border border-gray-300 px-2 py-2">
                <input type="text" name="search_volume[]" class="form-input w-full metric-sv" placeholder="Enter search volume" required>
            </td>
            <td class="border border-gray-300 px-2 py-2 text-center">
                <button type="button" class="removeMetricRow text-red-600 hover:text-red-800 font-semibold">Remove</button>
            </td>
        `;
        return row;
    }

    // Add new metric row
    addMetricRowBtn.addEventListener('click', function() {
        const newRow = createMetricRow();
        metricsTableBody.appendChild(newRow);
        attachMetricRowListeners();
    });

    // Remove metric row
    function attachMetricRowListeners() {
        document.querySelectorAll('.removeMetricRow').forEach(button => {
            button.onclick = function() {
                const rows = metricsTableBody.querySelectorAll('.metric-row');
                if (rows.length > 1) {
                    this.closest('tr').remove();
                } else {
                    alert('At least one metric row is required.');
                }
            };
        });
    }

    // Initial attachment
    attachMetricRowListeners();

    // ===================================================================
    // DYNAMIC TABLE 2: Linking Data Management
    // ===================================================================
    const linkingTableBody = document.getElementById('linkingTableBody');
    const addLinkingRowBtn = document.getElementById('addLinkingRow');

    // Function to create a new linking row
    function createLinkingRow() {
        const row = document.createElement('tr');
        row.className = 'linking-row';
        row.innerHTML = `
            <td class="border border-gray-300 px-2 py-2">
                <input type="text" name="internal_linking_keywords[]" class="form-input w-full linking-keywords" placeholder="Enter keywords" required>
            </td>
            <td class="border border-gray-300 px-2 py-2">
                <input type="text" name="internal_link_urls[]" class="form-input w-full linking-urls" placeholder="Enter URLs" required>
            </td>
            <td class="border border-gray-300 px-2 py-2">
                <input type="text" name="internal_linking_keywords_sv[]" class="form-input w-full linking-sv" placeholder="Enter SV" required>
            </td>
            <td class="border border-gray-300 px-2 py-2 text-center">
                <button type="button" class="removeLinkingRow text-red-600 hover:text-red-800 font-semibold">Remove</button>
            </td>
        `;
        return row;
    }

    // Add new linking row
    addLinkingRowBtn.addEventListener('click', function() {
        const newRow = createLinkingRow();
        linkingTableBody.appendChild(newRow);
        attachLinkingRowListeners();
    });

    // Remove linking row
    function attachLinkingRowListeners() {
        document.querySelectorAll('.removeLinkingRow').forEach(button => {
            button.onclick = function() {
                const rows = linkingTableBody.querySelectorAll('.linking-row');
                if (rows.length > 1) {
                    this.closest('tr').remove();
                } else {
                    alert('At least one linking row is required.');
                }
            };
        });
    }

    // Initial attachment
    attachLinkingRowListeners();

    // ===================================================================
    // Toggle sections and required attributes based on category type
    // ===================================================================
    function toggleSections() {
        const selectedValue = categoryTypeSelect.value;

        if (selectedValue === 'Category') {
            // Show category section, hide blog section
            categorySection.style.display = 'block';
            blogSection.style.display = 'none';

            // Set required attribute and show asterisks for category fields
            document.querySelectorAll('.category-field').forEach(field => {
                field.setAttribute('required', 'required');
            });
            document.querySelectorAll('#categorySection .required-indicator').forEach(indicator => {
                indicator.style.display = 'inline';
            });

            // Remove required attribute and hide asterisks for blog fields
            document.querySelectorAll('.blog-field').forEach(field => {
                field.removeAttribute('required');
            });
            document.querySelectorAll('#blogSection .required-indicator').forEach(indicator => {
                indicator.style.display = 'none';
            });

        } else if (selectedValue === 'Blog') {
            // Show blog section, hide category section
            categorySection.style.display = 'none';
            blogSection.style.display = 'block';

            // Set required attribute and show asterisks for blog fields
            document.querySelectorAll('.blog-field').forEach(field => {
                field.setAttribute('required', 'required');
            });
            document.querySelectorAll('#blogSection .required-indicator').forEach(indicator => {
                indicator.style.display = 'inline';
            });

            // Remove required attribute and hide asterisks for category fields
            document.querySelectorAll('.category-field').forEach(field => {
                field.removeAttribute('required');
            });
            document.querySelectorAll('#categorySection .required-indicator').forEach(indicator => {
                indicator.style.display = 'none';
            });

        } else {
            // Hide both sections
            categorySection.style.display = 'none';
            blogSection.style.display = 'none';

            // Remove required attribute and hide asterisks from both
            document.querySelectorAll('.category-field, .blog-field').forEach(field => {
                field.removeAttribute('required');
            });
            document.querySelectorAll('#categorySection .required-indicator, #blogSection .required-indicator').forEach(indicator => {
                indicator.style.display = 'none';
            });
        }
    }

    categoryTypeSelect.addEventListener('change', toggleSections);

    // Initial check on page load
    toggleSections();

    // ===================================================================
    // Client-side validation
    // ===================================================================
    form.addEventListener('submit', function(e) {
        const errors = [];

        // Clear previous error styling
        document.querySelectorAll('.form-input').forEach(field => {
            field.classList.remove('border-red-500');
        });

        // Validate Content Metrics Table (at least one row with all fields filled)
        const metricRows = metricsTableBody.querySelectorAll('.metric-row');
        if (metricRows.length === 0) {
            errors.push('At least one Content Metric row is required');
        } else {
            metricRows.forEach((row, index) => {
                const type = row.querySelector('.metric-type');
                const keyword = row.querySelector('.metric-keyword');
                const sv = row.querySelector('.metric-sv');

                if (!type.value) {
                    errors.push(`Content Metrics Row ${index + 1}: Type is required`);
                    type.classList.add('border-red-500');
                }
                if (!keyword.value.trim()) {
                    errors.push(`Content Metrics Row ${index + 1}: Keyword is required`);
                    keyword.classList.add('border-red-500');
                }
                if (!sv.value.trim()) {
                    errors.push(`Content Metrics Row ${index + 1}: Search Volume is required`);
                    sv.classList.add('border-red-500');
                }
            });
        }

        // Validate Linking Data Table (at least one row with all fields filled)
        const linkingRows = linkingTableBody.querySelectorAll('.linking-row');
        if (linkingRows.length === 0) {
            errors.push('At least one Linking Data row is required');
        } else {
            linkingRows.forEach((row, index) => {
                const keywords = row.querySelector('.linking-keywords');
                const urls = row.querySelector('.linking-urls');
                const sv = row.querySelector('.linking-sv');

                if (!keywords.value.trim()) {
                    errors.push(`Linking Data Row ${index + 1}: Keywords are required`);
                    keywords.classList.add('border-red-500');
                }
                if (!urls.value.trim()) {
                    errors.push(`Linking Data Row ${index + 1}: URLs are required`);
                    urls.classList.add('border-red-500');
                }
                if (!sv.value.trim()) {
                    errors.push(`Linking Data Row ${index + 1}: SV is required`);
                    sv.classList.add('border-red-500');
                }
            });
        }

        // Validate all other required fields that are visible
        const requiredFields = form.querySelectorAll('[required]');

        requiredFields.forEach(field => {
            // Skip table fields (already validated above)
            if (field.name.includes('[]')) {
                return;
            }

            // Skip if field is in a hidden section
            const parent = field.closest('#categorySection, #blogSection');
            if (parent && parent.style.display === 'none') {
                return;
            }

            // Check if field is empty
            const isEmpty = field.value === '' || field.value === null ||
                           (field.tagName === 'SELECT' && field.value === '') ||
                           (field.type === 'text' && field.value.trim() === '') ||
                           (field.type === 'number' && field.value === '') ||
                           (field.tagName === 'TEXTAREA' && field.value.trim() === '');

            if (isEmpty) {
                const label = field.closest('div').querySelector('label');
                const fieldName = label ? label.textContent.replace('*', '').replace('(Optional)', '').trim() : field.name;
                errors.push(`${fieldName} is required`);
                field.classList.add('border-red-500');
            }
        });

        // Validate category type is selected
        if (categoryTypeSelect.value === '') {
            if (!errors.includes('Content Type is required')) {
                errors.push('Content Type is required');
                categoryTypeSelect.classList.add('border-red-500');
            }
        }

        // If there are errors, prevent submission and show summary
        if (errors.length > 0) {
            e.preventDefault();

            // Show validation summary
            validationErrorList.innerHTML = '';
            errors.forEach(error => {
                const li = document.createElement('li');
                li.textContent = error;
                validationErrorList.appendChild(li);
            });

            validationSummary.style.display = 'block';

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });

            return false;
        }

        // Hide validation summary if no errors
        validationSummary.style.display = 'none';
    });

    // Real-time validation - remove error styling when user starts typing
    form.querySelectorAll('.form-input').forEach(field => {
        field.addEventListener('input', function() {
            if (this.value.trim() !== '') {
                this.classList.remove('border-red-500');
            }
        });

        field.addEventListener('change', function() {
            if (this.value.trim() !== '' || (this.tagName === 'SELECT' && this.value !== '')) {
                this.classList.remove('border-red-500');
            }
        });
    });
});
</script>

<style>
/* Additional error styling */
.form-error {
    color: #dc2626;
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

.border-red-500 {
    border-color: #ef4444 !important;
    background-color: #fef2f2;
}

.border-red-500:focus {
    border-color: #dc2626 !important;
    ring-color: #dc2626 !important;
}

.required-indicator {
    display: none;
}
</style>
{% endblock %}
