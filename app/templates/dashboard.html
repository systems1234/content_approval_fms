{% extends "base.html" %}

{% block title %}Dashboard - GemPundit CRM{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Dashboard</h1>
            <p class="text-gray-600 mt-1">Welcome back, {{ current_user.username }}!</p>
        </div>
        {% if current_user.is_manager() %}
        <a href="{{ url_for('main.create_task') }}" class="btn btn-primary">
            <svg class="inline w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Create New Task
        </a>
        {% endif %}
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
        <div class="card hover:shadow-lg transition-shadow">
            <div class="card-body">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Total Tasks</p>
                        <p class="text-3xl font-bold text-gray-900">{{ stats.total }}</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <div class="card hover:shadow-lg transition-shadow">
            <div class="card-body">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Assigned</p>
                        <p class="text-3xl font-bold text-gray-700">{{ stats.assigned }}</p>
                    </div>
                    <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <div class="card hover:shadow-lg transition-shadow">
            <div class="card-body">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">In Progress</p>
                        <p class="text-3xl font-bold text-blue-600">{{ stats.in_progress }}</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <div class="card hover:shadow-lg transition-shadow">
            <div class="card-body">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Under Audit</p>
                        <p class="text-3xl font-bold text-yellow-600">{{ stats.under_audit }}</p>
                    </div>
                    <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <div class="card hover:shadow-lg transition-shadow">
            <div class="card-body">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Completed</p>
                        <p class="text-3xl font-bold text-green-600">{{ stats.completed }}</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="card">
        <div class="card-body">
            <form method="GET" action="{{ url_for('main.dashboard') }}" class="flex gap-2">
                <div class="flex-1">
                    <input type="text"
                           name="search"
                           value="{{ search_query or '' }}"
                           placeholder="Search by Ticket ID, Title, or Description..."
                           class="form-input">
                </div>
                <button type="submit" class="btn btn-primary">
                    <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    Search
                </button>
                {% if search_query %}
                <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline">
                    Clear
                </a>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- Filters -->
    <div class="card">
        <div class="card-body">
            <div class="flex flex-wrap gap-2">
                <a href="{{ url_for('main.dashboard', search=search_query if search_query else None) }}"
                   class="btn {{ 'btn-primary' if not status_filter else 'btn-outline' }}">
                    All Tasks
                </a>
                <a href="{{ url_for('main.dashboard', status='assigned', search=search_query if search_query else None) }}"
                   class="btn {{ 'btn-primary' if status_filter == 'assigned' else 'btn-outline' }}">
                    Assigned
                </a>
                <a href="{{ url_for('main.dashboard', status='in_progress', search=search_query if search_query else None) }}"
                   class="btn {{ 'btn-primary' if status_filter == 'in_progress' else 'btn-outline' }}">
                    In Progress
                </a>
                <a href="{{ url_for('main.dashboard', status='under_audit', search=search_query if search_query else None) }}"
                   class="btn {{ 'btn-primary' if status_filter == 'under_audit' else 'btn-outline' }}">
                    Under Audit
                </a>
                <a href="{{ url_for('main.dashboard', status='audit_passed', search=search_query if search_query else None) }}"
                   class="btn {{ 'btn-primary' if status_filter == 'audit_passed' else 'btn-outline' }}">
                    Passed
                </a>
            </div>
        </div>
    </div>

    <!-- Tasks List -->
    <div class="card">
        <div class="card-header">
            <h2 class="text-xl font-semibold text-gray-900">Tasks</h2>
        </div>
        <div class="divide-y divide-gray-200">
            {% if tasks.items %}
                {% for task in tasks.items %}
                <a href="{{ url_for('main.task_detail', task_id=task.id) }}"
                   class="block hover:bg-gray-50 transition-colors">
                    <div class="px-6 py-4">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="text-xs font-mono font-semibold text-blue-600 bg-blue-50 px-2 py-1 rounded">
                                        {{ task.ticket_id }}
                                    </span>
                                    <h3 class="text-lg font-medium text-gray-900">{{ task.title }}</h3>
                                    <span class="badge {{ task.get_status_badge_class() }}">
                                        {{ task.status.replace('_', ' ').title() }}
                                    </span>
                                </div>
                                {% if task.description %}
                                <p class="text-gray-600 text-sm mb-3 line-clamp-2">{{ task.description }}</p>
                                {% endif %}
                                <div class="flex flex-wrap gap-4 text-sm text-gray-500">
                                    <span class="flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                        {{ task.assignee.username }}
                                    </span>
                                    {% if task.auditor %}
                                    <span class="flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        Auditor: {{ task.auditor.username }}
                                    </span>
                                    {% endif %}
                                    <span class="flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                  d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                        {{ task.created_at.strftime('%Y-%m-%d %H:%M') }}
                                    </span>
                                    {% if task.revision_count > 0 %}
                                    <span class="badge bg-orange-100 text-orange-800">
                                        {{ task.revision_count }} revision{{ 's' if task.revision_count > 1 else '' }}
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                            <svg class="w-5 h-5 text-gray-400 flex-shrink-0 ml-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </div>
                    </div>
                </a>
                {% endfor %}
            {% else %}
                <div class="px-6 py-12 text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No tasks found</h3>
                    <p class="mt-1 text-sm text-gray-500">Get started by creating a new task.</p>
                    {% if current_user.is_manager() %}
                    <div class="mt-6">
                        <a href="{{ url_for('main.create_task') }}" class="btn btn-primary">
                            Create Task
                        </a>
                    </div>
                    {% endif %}
                </div>
            {% endif %}
        </div>

        <!-- Advanced Pagination -->
        {% if tasks.total > 0 %}
        <div class="px-6 py-4 bg-gray-50 border-t border-gray-200">
            <!-- Mobile Pagination -->
            <div class="sm:hidden">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm text-gray-700">
                        {{ ((tasks.page - 1) * per_page + 1) }}-{{ [tasks.page * per_page, tasks.total]|min }} of {{ tasks.total }}
                    </span>
                    <div class="flex gap-2">
                        <a href="{{ url_for('main.dashboard', page=tasks.prev_num if tasks.has_prev else 1, per_page=per_page, status=status_filter, search=search_query) }}"
                           class="btn btn-outline btn-sm {{ 'opacity-50 pointer-events-none' if not tasks.has_prev }}"
                           {{ 'aria-disabled=true' if not tasks.has_prev }}>
                            Prev
                        </a>
                        <a href="{{ url_for('main.dashboard', page=tasks.next_num if tasks.has_next else tasks.pages, per_page=per_page, status=status_filter, search=search_query) }}"
                           class="btn btn-outline btn-sm {{ 'opacity-50 pointer-events-none' if not tasks.has_next }}"
                           {{ 'aria-disabled=true' if not tasks.has_next }}>
                            Next
                        </a>
                    </div>
                </div>
            </div>

            <!-- Desktop Pagination -->
            <div class="hidden sm:flex items-center justify-between flex-wrap gap-4">
                <!-- Left: Item count -->
                <div class="text-sm text-gray-700">
                    <span class="font-medium">{{ ((tasks.page - 1) * per_page + 1) }}-{{ [tasks.page * per_page, tasks.total]|min }}</span>
                    <span class="text-gray-500"> of </span>
                    <span class="font-medium">{{ tasks.total }}</span>
                </div>

                <!-- Center: Page navigation -->
                <nav class="flex items-center gap-1" aria-label="Pagination">
                    <!-- Previous Button -->
                    <a href="{{ url_for('main.dashboard', page=tasks.prev_num if tasks.has_prev else 1, per_page=per_page, status=status_filter, search=search_query) }}"
                       class="pagination-btn {{ 'pagination-btn-disabled' if not tasks.has_prev }}"
                       aria-label="Previous page"
                       {{ 'aria-disabled=true' if not tasks.has_prev }}>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        <span class="ml-1">Prev</span>
                    </a>

                    <!-- Page Numbers -->
                    {% set start_page = [1, tasks.page - 2]|max %}
                    {% set end_page = [tasks.pages, tasks.page + 2]|min %}

                    {% if start_page > 1 %}
                        <a href="{{ url_for('main.dashboard', page=1, per_page=per_page, status=status_filter, search=search_query) }}"
                           class="pagination-number">1</a>
                        {% if start_page > 2 %}
                            <span class="pagination-ellipsis">…</span>
                        {% endif %}
                    {% endif %}

                    {% for p in range(start_page, end_page + 1) %}
                        <a href="{{ url_for('main.dashboard', page=p, per_page=per_page, status=status_filter, search=search_query) }}"
                           class="pagination-number {{ 'pagination-number-active' if p == tasks.page }}"
                           aria-label="Page {{ p }}"
                           {{ 'aria-current=page' if p == tasks.page }}>
                            {{ p }}
                        </a>
                    {% endfor %}

                    {% if end_page < tasks.pages %}
                        {% if end_page < tasks.pages - 1 %}
                            <span class="pagination-ellipsis">…</span>
                        {% endif %}
                        <a href="{{ url_for('main.dashboard', page=tasks.pages, per_page=per_page, status=status_filter, search=search_query) }}"
                           class="pagination-number">{{ tasks.pages }}</a>
                    {% endif %}

                    <!-- Next Button -->
                    <a href="{{ url_for('main.dashboard', page=tasks.next_num if tasks.has_next else tasks.pages, per_page=per_page, status=status_filter, search=search_query) }}"
                       class="pagination-btn {{ 'pagination-btn-disabled' if not tasks.has_next }}"
                       aria-label="Next page"
                       {{ 'aria-disabled=true' if not tasks.has_next }}>
                        <span class="mr-1">Next</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </a>
                </nav>

                <!-- Right: Items per page & Jump to page -->
                <div class="flex items-center gap-3">
                    <!-- Items per page dropdown -->
                    <div class="flex items-center gap-2">
                        <label for="perPageSelect" class="text-sm text-gray-700">Show:</label>
                        <select id="perPageSelect"
                                class="pagination-select"
                                onchange="changePerPage(this.value)">
                            <option value="10" {{ 'selected' if per_page == 10 }}>10</option>
                            <option value="25" {{ 'selected' if per_page == 25 }}>25</option>
                            <option value="50" {{ 'selected' if per_page == 50 }}>50</option>
                            <option value="100" {{ 'selected' if per_page == 100 }}>100</option>
                        </select>
                        <span class="text-sm text-gray-700">/ page</span>
                    </div>

                    <!-- Jump to page -->
                    <div class="flex items-center gap-2">
                        <label for="jumpToPage" class="text-sm text-gray-700">Go to:</label>
                        <input type="number"
                               id="jumpToPage"
                               class="pagination-input"
                               placeholder="Page"
                               min="1"
                               max="{{ tasks.pages }}"
                               onkeypress="handlePageJump(event, {{ tasks.pages }})"
                               aria-label="Jump to page">
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Pagination JavaScript
(function() {
    'use strict';

    // Get current URL parameters
    function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
            status: params.get('status') || '',
            search: params.get('search') || '',
            page: params.get('page') || '1',
            per_page: params.get('per_page') || '10'
        };
    }

    // Build URL with parameters
    function buildUrl(page, perPage) {
        const params = getUrlParams();
        const url = new URL(window.location.href);
        url.searchParams.set('page', page);
        url.searchParams.set('per_page', perPage || params.per_page);

        // Preserve other filters
        if (params.status) {
            url.searchParams.set('status', params.status);
        }
        if (params.search) {
            url.searchParams.set('search', params.search);
        }

        return url.toString();
    }

    // Change items per page
    window.changePerPage = function(perPage) {
        // Reset to page 1 when changing per_page
        window.location.href = buildUrl(1, perPage);
    };

    // Handle page jump on Enter key
    window.handlePageJump = function(event, maxPages) {
        if (event.key === 'Enter' || event.keyCode === 13) {
            event.preventDefault();

            const input = event.target;
            let pageNum = parseInt(input.value);

            // Validate page number
            if (isNaN(pageNum) || pageNum < 1) {
                pageNum = 1;
            } else if (pageNum > maxPages) {
                pageNum = maxPages;
            }

            // Update input value to validated number
            input.value = pageNum;

            // Navigate to page
            const params = getUrlParams();
            window.location.href = buildUrl(pageNum, params.per_page);
        }
    };

    // Optional: Add button for jump to page (in case Enter doesn't work)
    const jumpInput = document.getElementById('jumpToPage');
    if (jumpInput) {
        // Clear placeholder on focus
        jumpInput.addEventListener('focus', function() {
            this.placeholder = '';
        });

        // Restore placeholder on blur if empty
        jumpInput.addEventListener('blur', function() {
            if (this.value === '') {
                this.placeholder = 'Page';
            }
        });
    }

    // Prevent disabled links from navigating
    document.querySelectorAll('.pagination-btn-disabled').forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            return false;
        });
    });

})();
</script>
{% endblock %}
